-- =============================================
-- SCRIPT GAME STRUCTURE LOGGER - DEEP SCAN V2 (FIXED)
-- Membedakan NPC dan MOB, menampilkan semua nama unik
-- FIX: Error nil value di line 382
-- =============================================

local player = game.Players.LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")
local players = game:GetService("Players")

-- Fungsi formatting
local function logSection(title)
    print("\n" .. string.rep("=", 70))
    print("ðŸ“‹ " .. title)
    print(string.rep("=", 70))
end

local function logInfo(label, value)
    print("  â€¢ " .. label .. ": " .. tostring(value))
end

local function logSuccess(label, value)
    print("  âœ… " .. label .. ": " .. tostring(value))
end

local function logWarning(label, value)
    print("  âš ï¸ " .. label .. ": " .. tostring(value))
end

-- =============================================
-- KATA KUNCI UNTUK DETEKSI NPC
-- =============================================
local NPC_KEYWORDS = {
    -- Bahasa Inggris
    "npc", "merchant", "shop", "trader", "guard", "banker", "vendor",
    "blacksmith", "innkeeper", "bartender", "priest", "trainer", "quest",
    "guide", "elder", "shaman", "healer", "smith", "farmer", "fisherman",
    "miner", "hunter", "chef", "baker", "alchemist", "enchanter", "armorer",
    "weaponsmith", "jeweler", "tailor", "leatherworker", "carpenter",
    
    -- Bahasa Indonesia
    "pedagang", "penjual", "toko", "penjaga", "bank", "pandu", "pemimpin",
    "dukun", "penyembuh", "pandai besi", "tukang", "nelayan", "penambang",
    "pemburu", "koki", "tukang roti", "alkemis", "penyihir", "guru",
}

-- =============================================
-- FUNGSI SCAN REKURSIF UNTUK SEMUA MOB/NPC
-- =============================================
local mobNames = {}      -- Untuk menyimpan nama unik mob
local npcNames = {}      -- Untuk menyimpan nama unik NPC
local mobDetails = {}    -- Detail lengkap mob
local npcDetails = {}    -- Detail lengkap NPC
local folderStructure = {}  -- Struktur folder

local function isNPC(name)
    name = name:lower()
    for _, keyword in ipairs(NPC_KEYWORDS) do
        if name:find(keyword) then
            return true
        end
    end
    return false
end

local function scanDeep(container, path, depth)
    depth = depth or 0
    if depth > 10 then return end  -- Batasi kedalaman
    
    for _, obj in ipairs(container:GetChildren()) do
        local currentPath = path .. "/" .. obj.Name
        
        -- Catat folder
        if obj:IsA("Folder") then
            table.insert(folderStructure, {
                name = obj.Name,
                path = currentPath,
                childCount = #obj:GetChildren()
            })
            scanDeep(obj, currentPath, depth + 1)
        end
        
        -- Cek model dengan Humanoid
        if obj:IsA("Model") then
            local humanoid = obj:FindFirstChild("Humanoid")
            if humanoid and not players:GetPlayerFromCharacter(obj) then
                
                -- Deteksi root part
                local rootPart = obj:FindFirstChild("HumanoidRootPart") or 
                                 obj:FindFirstChild("Torso") or 
                                 obj:FindFirstChild("UpperTorso") or
                                 obj:FindFirstChild("LowerTorso") or
                                 obj:FindFirstChildOfClass("BasePart")
                
                local data = {
                    name = obj.Name,
                    path = currentPath,
                    health = humanoid.Health,
                    maxHealth = humanoid.MaxHealth,
                    rootPart = rootPart and rootPart.Name or "tidak ada",
                    position = rootPart and rootPart.Position,
                    folder = container.Name
                }
                
                -- Cek apakah ini NPC atau MOB
                if isNPC(obj.Name) then
                    -- Ini NPC
                    if not npcNames[obj.Name] then
                        npcNames[obj.Name] = true
                        table.insert(npcDetails, data)
                    end
                else
                    -- Ini MOB (musuh)
                    if not mobNames[obj.Name] then
                        mobNames[obj.Name] = true
                        table.insert(mobDetails, data)
                    end
                end
            end
        end
    end
end

-- =============================================
-- FUNGSI DETEKSI DAMAGE METHOD
-- =============================================
local function detectDamageMethods()
    local methods = {}
    
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        local hum = player.Character.Humanoid
        
        -- Test HEALTH_DIRECT
        local canDirect = pcall(function()
            local old = hum.Health
            hum.Health = old
            return true
        end)
        if canDirect then table.insert(methods, "HEALTH_DIRECT") end
        
        -- Test TAKE_DAMAGE
        if hum.TakeDamage then
            table.insert(methods, "TAKE_DAMAGE")
        end
    end
    
    return methods
end

-- =============================================
-- FUNGSI DETEKSI REMOTE EVENTS
-- =============================================
local function detectRemotes()
    local remotes = {
        attack = {},
        damage = {},
        sell = {},
        buy = {},
        other = {}
    }
    
    local function categorizeRemote(name)
        name = name:lower()
        if name:find("attack") or name:find("serang") then
            return "attack"
        elseif name:find("damage") or name:find("hit") then
            return "damage"
        elseif name:find("sell") or name:find("jual") then
            return "sell"
        elseif name:find("buy") or name:find("beli") then
            return "buy"
        else
            return "other"
        end
    end
    
    for _, obj in ipairs(replicatedStorage:GetChildren()) do
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            local category = categorizeRemote(obj.Name)
            table.insert(remotes[category], obj.Name)
        end
    end
    
    return remotes
end

-- =============================================
-- FUNGSI UNTUK MENGURUTKAN TABLE
-- =============================================
local function getSortedKeys(tbl)
    local keys = {}
    if not tbl then return keys end
    for key, _ in pairs(tbl) do
        table.insert(keys, key)
    end
    table.sort(keys)
    return keys
end

-- =============================================
-- MAIN LOGGER
-- =============================================
logSection("GAME STRUCTURE LOGGER - DEEP SCAN V2 (FIXED)")
logInfo("Game ID", game.PlaceId)
logInfo("Game Name", game.Name)
logInfo("Player", player.Name)
logInfo("Timestamp", os.date("%Y-%m-%d %H:%M:%S"))

-- =============================================
-- 1. INFORMASI KARAKTER
-- =============================================
logSection("INFORMASI KARAKTER")

if player.Character then
    logSuccess("Nama Karakter", player.Character.Name)
    
    local rootPart = player.Character:FindFirstChild("HumanoidRootPart") and "HumanoidRootPart" or
                     player.Character:FindFirstChild("Torso") and "Torso" or "Tidak ditemukan"
    logSuccess("Root Part Name", rootPart)
    
    local humanoid = player.Character:FindFirstChild("Humanoid")
    if humanoid then
        logInfo("Health", humanoid.Health .. "/" .. humanoid.MaxHealth)
        local methods = detectDamageMethods()
        logInfo("Damage Methods", table.concat(methods, ", "))
    end
end

-- =============================================
-- 2. DEEP SCAN - SEMUA ENTITAS
-- =============================================
logSection("DEEP SCAN - SEMUA ENTITAS")

-- Reset data
mobNames = {}
npcNames = {}
mobDetails = {}
npcDetails = {}
folderStructure = {}

-- Lakukan scan
scanDeep(workspace, "workspace")

-- Tampilkan folder structure
if #folderStructure > 0 then
    logSuccess("Folder Ditemukan", #folderStructure)
    local uniqueFolders = {}
    for _, folder in ipairs(folderStructure) do
        if not uniqueFolders[folder.name] then
            uniqueFolders[folder.name] = true
            print("    ðŸ“ " .. folder.name)
        end
    end
end

-- =============================================
-- 3. DAFTAR NPC (YANG TIDAK BOLEH DISERANG)
-- =============================================
logSection("DAFTAR NPC - JANGAN DISERANG")

if #npcDetails > 0 then
    logSuccess("Total NPC Ditemukan", #npcDetails)
    print("\nðŸ“‹ DAFTAR NAMA NPC (UNIK):")
    
    local sortedNPCS = getSortedKeys(npcNames)
    for i, name in ipairs(sortedNPCS) do
        print("    " .. i .. ". " .. name)
    end
    
    print("\nðŸ“‹ DETAIL NPC (5 contoh pertama):")
    for i = 1, math.min(5, #npcDetails) do
        local npc = npcDetails[i]
        print("\n    ðŸ‘¤ NPC #" .. i .. ": " .. npc.name)
        print("        Lokasi: " .. npc.path)
        print("        Health: " .. npc.health .. "/" .. npc.maxHealth)
    end
else
    logInfo("NPC", "Tidak ditemukan NPC")
end

-- =============================================
-- 4. DAFTAR MOB (YANG BOLEH DISERANG)
-- =============================================
logSection("DAFTAR MOB - TARGET SERANGAN")

if #mobDetails > 0 then
    logSuccess("Total MOB Ditemukan", #mobDetails)
    print("\nðŸ“‹ DAFTAR NAMA MOB (UNIK) - " .. #mobDetails .. " jenis mob:")
    print("   (Copy daftar ini untuk filter)\n")
    
    local sortedMobs = getSortedKeys(mobNames)
    for i, name in ipairs(sortedMobs) do
        print("    " .. i .. ". " .. name)
    end
    
    print("\nðŸ“‹ DETAIL MOB (5 contoh pertama):")
    for i = 1, math.min(5, #mobDetails) do
        local mob = mobDetails[i]
        print("\n    âš”ï¸ Mob #" .. i .. ": " .. mob.name)
        print("        Lokasi: " .. mob.path)
        print("        Health: " .. mob.health .. "/" .. mob.maxHealth)
        if mob.position then
            print(string.format("        Posisi: X=%.1f, Y=%.1f, Z=%.1f", 
                  mob.position.X, mob.position.Y, mob.position.Z))
        end
    end
    
    -- Tampilkan statistik
    print("\nðŸ“Š STATISTIK MOB:")
    local totalHealth = 0
    for _, mob in ipairs(mobDetails) do
        totalHealth = totalHealth + mob.maxHealth
    end
    local avgHealth = totalHealth / #mobDetails
    print("    Rata-rata Health: " .. math.floor(avgHealth))
    print("    Total Jenis Mob: " .. #sortedMobs)
    print("    Total Individu Mob: " .. #mobDetails)
    
else
    logWarning("MOB", "TIDAK ADA MOB TERDETEKSI!")
end

-- =============================================
-- 5. REMOTE EVENTS
-- =============================================
logSection("REMOTE EVENTS")

local remotes = detectRemotes()
local hasAttackRemote = false

for category, list in pairs(remotes) do
    if #list > 0 then
        logSuccess("Remote " .. category:upper(), #list)
        for _, name in ipairs(list) do
            print("    ðŸ“¡ " .. name)
            if category == "attack" or category == "damage" then
                hasAttackRemote = true
            end
        end
    end
end

if not hasAttackRemote then
    logInfo("Remote Attack", "Tidak ada, gunakan HEALTH_DIRECT")
end

-- =============================================
-- 6. RANGKUMAN DATA UNTUK SCRIPT
-- =============================================
logSection("ðŸ“Š RANGKUMAN DATA - COPY KE SAYA")

print([[
==================================================
            HASIL SCAN GAME - LENGKAP
==================================================
]])

print("ðŸ“Œ INFORMASI DASAR:")
print("Game ID:", game.PlaceId)
print("Game Name:", game.Name)
print("Player:", player.Name)
print("Root Part:", player.Character and (player.Character:FindFirstChild("HumanoidRootPart") and "HumanoidRootPart" or "Torso") or "Unknown")
print("Damage Method:", detectDamageMethods()[1] or "HEALTH_DIRECT")

print("\nðŸ“Œ DATA NPC (" .. #npcDetails .. " total, " .. (#npcNames and #npcNames or 0) .. " jenis):")
if #npcDetails > 0 then
    local npcList = getSortedKeys(npcNames)
    print("Contoh NPC:", npcList[1] or "-")
    print("Jumlah Jenis NPC:", #npcList)
else
    print("Tidak ada NPC terdeteksi")
end

print("\nðŸ“Œ DATA MOB (" .. #mobDetails .. " total, " .. (#mobNames or 0) .. " jenis):")
if #mobDetails > 0 then
    local mobList = getSortedKeys(mobNames)
    print("Total Mob Ditemukan:", #mobDetails)
    print("Jenis Mob (Unik):", #mobList)
    print("\nðŸ“‹ DAFTAR LENGKAP NAMA MOB (UNTUK FILTER):")
    print("targetMobFilters = {")
    for i, name in ipairs(mobList) do
        local line = '    "' .. name .. '"'
        if i < #mobList then
            line = line .. ","
        end
        print(line)
    end
    print("}")
    
    print("\nðŸ“‹ DAFTAR NPC (UNTUK DIHINDARI):")
    local npcList = getSortedKeys(npcNames)
    if #npcList > 0 then
        print("npcNames = {")
        for i, name in ipairs(npcList) do
            local line = '    "' .. name .. '"'
            if i < #npcList then
                line = line .. ","
            end
            print(line)
        end
        print("}")
    else
        print("npcNames = {}  -- Tidak ada NPC")
    end
else
    print("Tidak ada mob terdeteksi")
end

print("\nðŸ“Œ FOLDER PENTING:")
local uniqueFolders = {}
for _, folder in ipairs(folderStructure) do
    if not uniqueFolders[folder.name] then
        uniqueFolders[folder.name] = true
        print("  -", folder.name)
    end
end

print("\nðŸ“Œ REMOTE PENTING:")
if hasAttackRemote then
    for category, list in pairs(remotes) do
        if category == "attack" or category == "damage" then
            for _, name in ipairs(list) do
                print("  -", name, "(" .. category .. ")")
            end
        end
    end
else
    print("  Tidak ada remote attack, gunakan HEALTH_DIRECT")
end

print("\n==================================================")
print("âœ… KIRIMKAN DATA DI ATAS KE SAYA")
print("==================================================")

-- =============================================
-- 7. READY-TO-USE CONFIG
-- =============================================
logSection("READY-TO-USE CONFIGURATION")

print("\n-- Copy paste ini ke script Anda:\n")
print("local GAME_CONFIG = {")
print("    rootPartName = \"HumanoidRootPart\",")
print("    humanoidName = \"Humanoid\",")
print("    damageMethod = \"" .. (detectDamageMethods()[1] or "HEALTH_DIRECT") .. "\",")
print("")

-- Daftar mob untuk filter
if #mobDetails > 0 then
    local mobList = getSortedKeys(mobNames)
    print("    -- DAFTAR MOB YANG BOLEH DISERANG")
    print("    targetMobs = {")
    for i, name in ipairs(mobList) do
        local line = '        "' .. name .. '"'
        if i < #mobList then
            line = line .. ","
        end
        print(line)
    end
    print("    },")
else
    print("    targetMobs = {},  -- Tidak ada mob terdeteksi")
end
print("")

-- Daftar NPC untuk dihindari
if #npcDetails > 0 then
    local npcList = getSortedKeys(npcNames)
    print("    -- DAFTAR NPC YANG DIHINDARI")
    print("    npcNames = {")
    for i, name in ipairs(npcList) do
        local line = '        "' .. name .. '"'
        if i < #npcList then
            line = line .. ","
        end
        print(line)
    end
    print("    },")
else
    print("    npcNames = {},  -- Tidak ada NPC")
end
print("")

-- Folder penting
print("    -- FOLDER PENTING")
print("    importantFolders = {")
local folderList = {}
for folder, _ in pairs(uniqueFolders) do
    table.insert(folderList, folder)
end
table.sort(folderList)
for i, folder in ipairs(folderList) do
    local line = '        "' .. folder .. '"'
    if i < #folderList then
        line = line .. ","
    end
    print(line)
end
print("    }")
print("}")

logSection("LOGGING COMPLETE")
print("\nâœ… SCAN SELESAI! Kirim bagian RANGKUMAN DATA ke saya.")
